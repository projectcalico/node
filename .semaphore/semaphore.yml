version: v1.0
name: node
agent:
  machine:
    type: e1-standard-4
    os_image: ubuntu1804
execution_time_limit:
  minutes: 120
global_job_config:
  prologue:
    commands:
      - checkout
      # Semaphore is doing shallow clone on a commit without tags.
      # unshallow it for GIT_VERSION:=$(shell git describe --tags --dirty --always) @ Makefile.common
      - git fetch --unshallow

promotions:
- name: Auto-update and commit dependency pins
  pipeline_file: update-pins.yml
  # No auto-promotion, update-pins.yml gets run directly by the scheduler.

blocks:

# Run the full set of tests. Each job can potentially be run in parallel,
# provided Semaphore has enough boxes available.
- name: "Tests"
  execution_time_limit:
    # Semaphore's default is 1 hour, and these tests take about that time or a little
    # longer.
    minutes: 90
  dependencies: []
  task:
    jobs:
    - name: "make ci"
      commands:
      - make ci
    - name: "make k8s-test"
      commands:
      - make k8s-test

# If tests passed, then build and push images.
# We'll only do this on non-PR builds, where we have credentials to do so.
- name: "Push images (non-PR builds only)"
  skip:
    # Only run on branches, not PRs.
    when: "branch !~ '.+'"
  dependencies: ["Tests"]
  task:
    secrets:
    - name: quay-robot-calico+semaphoreci
    - name: docker
    jobs:
    - name: "make cd"
      commands:
      - echo $DOCKER_TOKEN | docker login --username "$DOCKER_USER" --password-stdin
      - echo $QUAY_TOKEN | docker login --username "$QUAY_USER" --password-stdin quay.io
      - export BRANCH_NAME=$SEMAPHORE_GIT_BRANCH
      - if [ -z "${SEMAPHORE_GIT_PR_NUMBER}" ]; then make image-all cd CONFIRM=true; fi

# remove later. build windows release and push to google store.
- name: "nightly build windows release"
  dependencies: []
  task:
    secrets:
    # Mount the github SSH secret for pulling private repositories.
    - name: banzai-secrets
    jobs:
    - name: "build windows release"
      commands:
      - mkdir -p $HOME/.local/bin
      - export PATH=$HOME/.local/bin:$PATH
      - mkdir -p $HOME/.docker
      - cp ~/secrets/docker_cfg.json $HOME/.docker/config.json
      # Login to docker in order to pull images.
      - export GOOGLE_APPLICATION_CREDENTIALS=$HOME/secrets/banzai-google-service-account.json
      - sudo apt-get update && sudo apt-get -y --only-upgrade install google-cloud-sdk
      - gcloud auth activate-service-account --key-file=${GOOGLE_APPLICATION_CREDENTIALS}
      - export BRANCH_NAME=$SEMAPHORE_GIT_BRANCH
      - make release-windows-archive VERSION=${BRANCH_NAME}
      - |
        if [[ $BRANCH_NAME =~ ^master.* ]]; then
          gsutil cp dist/calico-windows-${BRANCH_NAME}.zip gs://tigera-windows/tigera-calico-windows-${BRANCH_NAME}.zip
        fi

      env_vars:
      - name: GOOGLE_PROJECT
        value: unique-caldron-775
      - name: GOOGLE_REGION
        value: us-west1
      - name: GOOGLE_ZONE
        value: us-west1-b
      - name: GOOGLE_NETWORK
        value: semaphore-autotest

